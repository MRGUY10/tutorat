<!-- Message Composer Container -->
<div 
  class="message-composer bg-white border-t border-gray-200 relative"
  [class.drag-over]="isDragOver"
  (dragover)="onDragOver($event)"
  (dragleave)="onDragLeave($event)"
  (drop)="onDrop($event)"
  (click)="onClickOutside($event)">

  <!-- File Upload Progress Bar -->
  <div *ngIf="uploadingFiles.length > 0" class="px-4 py-2 bg-blue-50 border-b border-blue-200">
    <div class="space-y-2">
      <div *ngFor="let file of uploadingFiles" class="flex items-center space-x-3">
        <i [class]="getFileIcon(file)" class="text-blue-600"></i>
        <div class="flex-1">
          <p class="text-sm font-medium text-blue-900">{{ file.name }}</p>
          <div class="w-full bg-blue-200 rounded-full h-2">
            <div
              class="bg-blue-600 h-2 rounded-full transition-all duration-300"
              [style.width.%]="uploadProgress.get(file.name) || 0">
            </div>
          </div>
        </div>
        <span class="text-xs text-blue-700">
          {{ uploadProgress.get(file.name) || 0 }}%
        </span>
      </div>
    </div>
  </div>

  <!-- Voice Recording Bar -->
  <div *ngIf="isRecordingVoice" class="px-4 py-3 bg-red-50 border-b border-red-200">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 bg-red-500 rounded-full voice-recording"></div>
          <span class="text-sm font-medium text-red-900">Enregistrement en cours...</span>
        </div>
        <span class="text-sm text-red-700">{{ formatDuration(recordingDuration) }}</span>
      </div>
      
      <div class="flex items-center space-x-2">
        <button
          type="button"
          (click)="cancelVoiceRecording()"
          class="px-3 py-1 text-sm text-red-600 hover:text-red-800 border border-red-300 rounded-full hover:bg-red-100 transition-colors">
          Annuler
        </button>
        <button
          type="button"
          (click)="stopVoiceRecording()"
          class="px-3 py-1 text-sm bg-red-600 hover:bg-red-700 text-white rounded-full transition-colors">
          Terminer
        </button>
      </div>
    </div>
  </div>

  <!-- File Preview Section -->
  <div *ngIf="selectedFiles.length > 0" class="px-4 py-3 bg-gray-50 border-b border-gray-200">
    <div class="flex flex-wrap gap-3">
      <div
        *ngFor="let file of selectedFiles; trackBy: trackByFile"
        class="relative flex items-center bg-white rounded-lg border border-gray-200 p-3 max-w-xs">
        
        <!-- Image Preview -->
        <div *ngIf="file.type.startsWith('image/') && previewUrls.get(file.name)" class="flex-shrink-0 mr-3">
          <img
            [src]="previewUrls.get(file.name)"
            [alt]="file.name"
            class="w-12 h-12 object-cover rounded">
        </div>
        
        <!-- File Icon -->
        <div *ngIf="!file.type.startsWith('image/')" class="flex-shrink-0 mr-3">
          <i [class]="getFileIcon(file)" class="text-2xl text-gray-600"></i>
        </div>

        <!-- File Info -->
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium text-gray-900 truncate">{{ file.name }}</p>
          <p class="text-xs text-gray-500">{{ formatFileSize(file.size) }}</p>
        </div>

        <!-- Remove Button -->
        <button
          type="button"
          (click)="removeFile(file)"
          class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center text-xs transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Composer Form -->
  <form [formGroup]="messageForm" (ngSubmit)="sendMessage()" class="p-4">
    <div class="flex items-end space-x-3">
      
      <!-- Action Buttons Left -->
      <div class="flex items-center space-x-1">
        
        <!-- File Attachment -->
        <div class="relative" *ngIf="allowAttachments">
          <button
            type="button"
            class="p-2 text-gray-400 hover:text-blue-600 rounded-full hover:bg-blue-50 transition-colors"
            [disabled]="loading">
            <i class="fas fa-paperclip"></i>
          </button>
          
          <input
            #fileInput
            type="file"
            multiple
            (change)="onFileSelected($event)"
            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
            [accept]="allowedFileTypes.join(',')">
        </div>

        <!-- Voice Message -->
        <button
          *ngIf="allowVoiceMessages && !isRecordingVoice"
          type="button"
          (click)="startVoiceRecording()"
          class="p-2 text-gray-400 hover:text-green-600 rounded-full hover:bg-green-50 transition-colors"
          [disabled]="loading">
          <i class="fas fa-microphone"></i>
        </button>

        <!-- Image/Camera -->
        <button
          type="button"
          class="p-2 text-gray-400 hover:text-purple-600 rounded-full hover:bg-purple-50 transition-colors"
          [disabled]="loading">
          <i class="fas fa-image"></i>
        </button>
      </div>

      <!-- Message Input Area -->
      <div class="flex-1 relative">
        
        <!-- Auto-expanding Textarea -->
        <textarea
          #textArea
          formControlName="content"
          [placeholder]="placeholder"
          rows="1"
          class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none text-sm leading-relaxed transition-all duration-200"
          [class.border-red-300]="messageForm.get('content')?.invalid && messageForm.get('content')?.touched"
          [disabled]="loading || isRecordingVoice"
          (keydown)="onKeyDown($event)"
          (input)="autoResizeTextarea()"
          style="field-sizing: content; min-height: 44px; max-height: 120px;"></textarea>

        <!-- Character Counter -->
        <div 
          *ngIf="messageForm.get('content')?.value?.length > 1800"
          class="absolute bottom-1 right-12 text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-800">
          {{ 2000 - (messageForm.get('content')?.value?.length || 0) }}
        </div>

        <!-- Emoji Button -->
        <button
          type="button"
          (click)="toggleEmojiPicker()"
          class="absolute right-3 bottom-3 p-1 text-gray-400 hover:text-yellow-500 rounded transition-colors"
          [disabled]="loading || isRecordingVoice">
          <i class="fas fa-smile"></i>
        </button>
      </div>

      <!-- Send Button -->
      <button
        type="submit"
        [disabled]="!messageForm.valid || loading || (!messageForm.get('content')?.value?.trim() && selectedFiles.length === 0)"
        class="p-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-full transition-colors flex-shrink-0">
        
        <i *ngIf="!loading" class="fas fa-paper-plane"></i>
        <div *ngIf="loading" class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
      </button>
    </div>

    <!-- Advanced Options Toggle -->
    <div class="mt-3 flex items-center justify-between" *ngIf="!isRecordingVoice">
      
      <!-- Quick Replies -->
      <div class="flex flex-wrap gap-2" *ngIf="showQuickReplies">
        <button
          *ngFor="let reply of quickReplies"
          type="button"
          (click)="sendQuickReply(reply)"
          class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full transition-colors quick-reply-enter">
          {{ reply }}
        </button>
      </div>

      <!-- Actions Row -->
      <div class="flex items-center justify-between w-full">
        
        <!-- Left Actions -->
        <div class="flex items-center space-x-3">
          
          <!-- Quick Replies Toggle -->
          <button
            type="button"
            (click)="showQuickReplies = !showQuickReplies"
            class="text-xs text-gray-500 hover:text-gray-700 flex items-center space-x-1 transition-colors">
            <i class="fas fa-bolt"></i>
            <span>R√©ponses rapides</span>
          </button>

          <!-- Advanced Options -->
          <button
            type="button"
            (click)="showAdvancedOptions = !showAdvancedOptions"
            class="text-xs text-gray-500 hover:text-gray-700 flex items-center space-x-1 transition-colors">
            <i class="fas fa-cog"></i>
            <span>Options</span>
          </button>
        </div>

        <!-- Right Actions -->
        <div class="flex items-center space-x-3">
          
          <!-- Message Type Selector -->
          <select
            formControlName="type"
            class="text-xs border border-gray-200 rounded px-2 py-1 bg-white text-gray-600">
            <option value="TEXTE">Texte</option>
            <option value="FICHIER">Fichier</option>
            <option value="IMAGE">Image</option>
          </select>

          <!-- Keyboard Shortcut Hint -->
          <span class="text-xs text-gray-400">
            Ctrl + Entr√©e pour envoyer
          </span>
        </div>
      </div>
    </div>
  </form>

  <!-- Emoji Picker -->
  <div
    #emojiPicker
    *ngIf="showEmojiPicker"
    class="absolute bottom-full left-4 right-4 bg-white border border-gray-200 rounded-lg shadow-lg p-4 z-50 emoji-picker">
    
    <div class="mb-3">
      <h4 class="text-sm font-medium text-gray-900 mb-2">Emojis r√©cents</h4>
      <div class="flex flex-wrap gap-2">
        <button
          *ngFor="let emoji of recentEmojis"
          type="button"
          (click)="insertEmoji(emoji)"
          class="text-lg hover:bg-gray-100 w-8 h-8 rounded flex items-center justify-center transition-colors">
          {{ emoji }}
        </button>
      </div>
    </div>

    <div>
      <h4 class="text-sm font-medium text-gray-900 mb-2">Emojis populaires</h4>
      <div class="grid grid-cols-8 gap-1">
        <button
          *ngFor="let emoji of ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòä', 'üòá', 'üôÇ', 'ü§ó', 'ü§î', 'üòê', 'üòë', 'üò∂', 'üôÑ', 'üòè', 'üò£', 'üò•', 'üòÆ', 'ü§ê', 'üòØ', 'üò™', 'üò´', 'üò¥', 'üòå', 'üòõ', 'üòú', 'üòù', 'ü§§', 'üòí', 'üòì', 'üòî', 'üòï', 'üôÉ', 'ü§ë', 'üò≤', 'üò∑', 'ü§í', 'ü§ï', 'ü§ß', 'üòµ', 'ü§Ø', 'ü§†', 'üòé', 'ü§ì', 'üßê', 'üòà', 'üëª', 'üëΩ', 'ü§ñ', 'üí©', 'üò∫', 'üò∏', 'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø', 'üòæ', 'üëç', 'üëé', 'üëå', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üëá', '‚òùÔ∏è', '‚úã', 'ü§ö', 'üñêÔ∏è', 'üññ', 'üëã', 'ü§è', 'üí™', 'ü¶æ', 'üñï', '‚úçÔ∏è', 'üôè', 'ü¶∂', 'ü¶µ', 'üíÑ', 'üíã', 'üëÑ', 'ü¶∑', 'üëÖ', 'üëÇ', 'ü¶ª', 'üëÉ', 'üë£', 'üëÅÔ∏è', 'üëÄ', 'üß†', 'üó£Ô∏è', 'üë§', 'üë•']"
          type="button"
          (click)="insertEmoji(emoji)"
          class="text-lg hover:bg-gray-100 w-8 h-8 rounded flex items-center justify-center transition-colors">
          {{ emoji }}
        </button>
      </div>
    </div>
  </div>

  <!-- Validation Errors -->
  <div *ngIf="error" class="px-4 py-2 bg-red-50 border-t border-red-200">
    <div class="flex items-center space-x-2 text-red-800">
      <i class="fas fa-exclamation-circle text-sm"></i>
      <span class="text-sm">{{ error }}</span>
      <button
        type="button"
        (click)="error = null"
        class="ml-auto text-red-600 hover:text-red-800">
        <i class="fas fa-times text-sm"></i>
      </button>
    </div>
  </div>

  <!-- Advanced Options Panel -->
  <div *ngIf="showAdvancedOptions" class="px-4 py-3 bg-gray-50 border-t border-gray-200">
    <div class="grid grid-cols-2 gap-4 text-sm">
      
      <div>
        <label class="block text-gray-700 mb-1">Priorit√©</label>
        <select class="w-full text-xs border border-gray-200 rounded px-2 py-1 bg-white">
          <option value="normal">Normale</option>
          <option value="high">Haute</option>
          <option value="urgent">Urgente</option>
        </select>
      </div>

      <div>
        <label class="block text-gray-700 mb-1">Notification</label>
        <select class="w-full text-xs border border-gray-200 rounded px-2 py-1 bg-white">
          <option value="all">Tous</option>
          <option value="mentions">Mentions seulement</option>
          <option value="none">Aucune</option>
        </select>
      </div>

      <div class="col-span-2">
        <label class="flex items-center space-x-2">
          <input type="checkbox" class="rounded border-gray-300">
          <span class="text-gray-700">Marquer comme important</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Connection Status Warning -->
  <div
    *ngIf="!(messagingService.connectionStatus$ | async)"
    class="px-4 py-2 bg-yellow-50 border-t border-yellow-200 connection-warning">
    <div class="flex items-center text-yellow-800">
      <i class="fas fa-exclamation-triangle mr-2"></i>
      <span class="text-sm">Connexion perdue - Les messages seront envoy√©s lors de la reconnexion</span>
    </div>
  </div>
</div>

<!-- Helper method for trackBy -->
<ng-container>
  <!-- This section is hidden and contains helper methods -->
</ng-container>
